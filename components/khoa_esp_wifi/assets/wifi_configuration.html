<!DOCTYPE html>
<html>
<head>
    <title>VIBO Hub Configuration</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <style type="text/css">
        :root {
            --bg-color: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent-color: #FF6600;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .lang-switch {
            position: absolute;
            top: 0;
            right: 0;
        }
        
        .lang-switch select {
            padding: 5px;
            font-size: 14px;
            width: auto;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
        }

        h2 {
            font-size: 18px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .wifi-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .wifi-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .wifi-item:last-child {
            border-bottom: none;
        }

        .wifi-ssid {
            font-weight: 500;
        }

        .wifi-signal {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>VIBO Hub</h1>
            <div class="lang-switch">
                <select id="language" onchange="changeLanguage()">
                    <option value="en">English</option>
                    <option value="vi">Ti·∫øng Vi·ªát</option>
                </select>
            </div>
        </header>

        <!-- WiFi Configuration -->
        <div class="card">
            <h2 data-lang="wifi_config">WiFi Configuration</h2>
            <div id="wifi-status" style="margin-bottom: 15px; color: var(--text-secondary);"><span data-lang="status">Status</span>: <span data-lang="disconnected">Disconnected</span></div>
            
            <div class="input-group">
                <label data-lang="ssid">SSID</label>
                <input type="text" id="ssid" placeholder="Select or enter SSID" data-lang-placeholder="ssid_placeholder">
            </div>
            <div class="input-group">
                <label data-lang="password">Password</label>
                <input type="password" id="password" placeholder="Enter password" data-lang-placeholder="password_placeholder">
            </div>
            <button onclick="connectWifi()" id="connectBtn" data-lang="connect">Connect</button>

            <div style="margin-top: 20px;">
                <label data-lang="available_networks">Available Networks</label>
                <ul class="wifi-list" id="ap_list">
                    <li style="text-align: center; color: #999; padding: 10px;" data-lang="scanning">Scanning...</li>
                </ul>
            </div>
        </div>

        <!-- Saved Networks -->
        <div class="card" id="saved_card" style="display:none;">
            <h2 data-lang="saved_networks">Saved Networks</h2>
            <ul class="wifi-list" id="saved_list">
                <!-- Populated by JS -->
            </ul>
        </div>

        <!-- GPIO Settings -->
        <div class="card">
            <h2 data-lang="gpio_settings">GPIO Settings</h2>
            <div class="input-group">
                <label data-lang="led_pin">LED Pin (GPIO)</label>
                <input type="number" id="gpio_led" placeholder="e.g. 2">
            </div>
            <div class="input-group">
                <label data-lang="button_pin">Button Pin (GPIO)</label>
                <input type="number" id="gpio_button" placeholder="e.g. 0">
            </div>
            <div class="input-group" style="display: flex; justify-content: space-between; align-items: center;">
                <label style="margin:0" data-lang="active_low">Active Low</label>
                <label class="switch">
                    <input type="checkbox" id="gpio_active_low">
                    <span class="slider"></span>
                </label>
            </div>
            <button onclick="saveGpioConfig()" id="saveGpioBtn" data-lang="save_settings">Save Settings</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const translations = {
            en: {
                wifi_config: "WiFi Configuration",
                status: "Status",
                disconnected: "Disconnected",
                ssid: "SSID",
                ssid_placeholder: "Select or enter SSID",
                password: "Password",
                password_placeholder: "Enter password",
                connect: "Connect",
                connecting: "Connecting...",
                available_networks: "Available Networks",
                scanning: "Scanning...",
                no_networks: "No networks found",
                saved_networks: "Saved Networks",
                forget: "Forget",
                gpio_settings: "GPIO Settings",
                led_pin: "LED Pin (GPIO)",
                button_pin: "Button Pin (GPIO)",
                active_low: "Active Low",
                save_settings: "Save Settings",
                saving: "Saving...",
                saved: "Settings Saved",
                connected_redirect: "Connected! Redirecting...",
                error: "Error",
                connection_failed: "Connection failed",
                select_ssid: "Please select or enter SSID"
            },
            vi: {
                wifi_config: "C·∫•u h√¨nh WiFi",
                status: "Tr·∫°ng th√°i",
                disconnected: "Ch∆∞a k·∫øt n·ªëi",
                ssid: "T√™n WiFi (SSID)",
                ssid_placeholder: "Ch·ªçn ho·∫∑c nh·∫≠p t√™n WiFi",
                password: "M·∫≠t kh·∫©u",
                password_placeholder: "Nh·∫≠p m·∫≠t kh·∫©u",
                connect: "K·∫øt n·ªëi",
                connecting: "ƒêang k·∫øt n·ªëi...",
                available_networks: "M·∫°ng kh·∫£ d·ª•ng",
                scanning: "ƒêang qu√©t...",
                no_networks: "Kh√¥ng t√¨m th·∫•y m·∫°ng n√†o",
                saved_networks: "M·∫°ng ƒë√£ l∆∞u",
                forget: "Qu√™n",
                gpio_settings: "C√†i ƒë·∫∑t GPIO",
                led_pin: "Ch√¢n LED (GPIO)",
                button_pin: "Ch√¢n N√∫t nh·∫•n (GPIO)",
                active_low: "K√≠ch m·ª©c th·∫•p (Active Low)",
                save_settings: "L∆∞u c√†i ƒë·∫∑t",
                saving: "ƒêang l∆∞u...",
                saved: "ƒê√£ l∆∞u c√†i ƒë·∫∑t",
                connected_redirect: "ƒê√£ k·∫øt n·ªëi! ƒêang chuy·ªÉn h∆∞·ªõng...",
                error: "L·ªói",
                connection_failed: "K·∫øt n·ªëi th·∫•t b·∫°i",
                select_ssid: "Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p t√™n WiFi"
            }
        };

        let currentLang = 'en';

        function changeLanguage() {
            const lang = document.getElementById('language').value;
            currentLang = lang;
            const t = translations[lang];

            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (t[key]) el.textContent = t[key];
            });

            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                if (t[key]) el.placeholder = t[key];
            });
            
            localStorage.setItem('vibo_lang', lang);
        }

        // Helper to show toast
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // Load AP List
        function loadAPList() {
            fetch('/scan')
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('ap_list');
                    list.innerHTML = '';
                    if (data.aps && data.aps.length > 0) {
                        data.aps.forEach(ap => {
                            const li = document.createElement('li');
                            li.className = 'wifi-item';
                            li.innerHTML = `
                                <span class="wifi-ssid">${ap.ssid} ${ap.authmode === 0 ? 'üåê' : 'üîí'}</span>
                                <span class="wifi-signal">${ap.rssi} dBm</span>
                            `;
                            li.onclick = () => {
                                document.getElementById('ssid').value = ap.ssid;
                                document.getElementById('password').focus();
                            };
                            list.appendChild(li);
                        });
                    } else {
                        const t = translations[currentLang];
                        list.innerHTML = `<li style="text-align: center; color: #999; padding: 10px;">${t.no_networks}</li>`;
                    }
                    setTimeout(loadAPList, 10000); // Refresh every 10s
                })
                .catch(e => {
                    console.error(e);
                    setTimeout(loadAPList, 5000);
                });
        }

        // Load Saved List
        function loadSavedList() {
            fetch('/saved/list')
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('saved_list');
                    const card = document.getElementById('saved_card');
                    list.innerHTML = '';
                    if (data && data.length > 0) {
                        card.style.display = 'block';
                        const t = translations[currentLang];
                        data.forEach((ssid, index) => {
                            const li = document.createElement('li');
                            li.className = 'wifi-item';
                            li.innerHTML = `
                                <span class="wifi-ssid">${ssid}</span>
                                <button style="width: auto; padding: 5px 10px; font-size: 12px; background: #ff3b30;" onclick="deleteSaved(${index})">${t.forget}</button>
                            `;
                            list.appendChild(li);
                        });
                    } else {
                        card.style.display = 'none';
                    }
                });
        }

        // Delete Saved
        function deleteSaved(index) {
            fetch('/saved/delete?index=' + index)
                .then(res => res.json())
                .then(() => loadSavedList());
        }

        // Connect WiFi
        function connectWifi() {
            const t = translations[currentLang];
            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;
            if (!ssid) {
                showToast(t.select_ssid);
                return;
            }
            
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            btn.textContent = t.connecting;

            fetch('/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ssid, password})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(t.connected_redirect);
                    setTimeout(() => window.location.href = '/done.html', 2000);
                } else {
                    showToast(t.error + ': ' + (data.error || 'Unknown'));
                    btn.disabled = false;
                    btn.textContent = t.connect;
                }
            })
            .catch(e => {
                showToast(t.connection_failed);
                btn.disabled = false;
                btn.textContent = t.connect;
            });
        }

        // Save GPIO
        function saveGpioConfig() {
            const t = translations[currentLang];
            const led = document.getElementById('gpio_led').value;
            const btn = document.getElementById('gpio_button').value;
            const activeLow = document.getElementById('gpio_active_low').checked;
            
            const saveBtn = document.getElementById('saveGpioBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = t.saving;

            fetch('/gpio/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    led_pin: parseInt(led), 
                    button_pin: parseInt(btn),
                    active_low: activeLow
                })
            })
            .then(res => {
                if(res.ok) return res.json();
                throw new Error('Network response was not ok');
            })
            .then(data => {
                showToast(t.saved);
                saveBtn.disabled = false;
                saveBtn.textContent = t.save_settings;
            })
            .catch(e => {
                console.log('GPIO Save simulated');
                showToast(t.saved + ' (Simulation)');
                saveBtn.disabled = false;
                saveBtn.textContent = t.save_settings;
            });
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Load lang
            const savedLang = localStorage.getItem('vibo_lang');
            if (savedLang && translations[savedLang]) {
                document.getElementById('language').value = savedLang;
                changeLanguage();
            }

            loadAPList();
            loadSavedList();
            
            // Load existing GPIO config if available
            fetch('/gpio/config')
                .then(res => res.json())
                .then(data => {
                    if(data.led_pin) document.getElementById('gpio_led').value = data.led_pin;
                    if(data.button_pin) document.getElementById('gpio_button').value = data.button_pin;
                    if(data.active_low !== undefined) document.getElementById('gpio_active_low').checked = data.active_low;
                })
                .catch(() => console.log('No GPIO config found'));
        });
    </script>
</body>
</html>